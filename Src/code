using System;
using System.IO;
using System.Drawing;
using System.Drawing.Imaging;

class ImageProcessor
{
    static void Main()
    {
        Console.WriteLine("=== Обработчик изображений ===");
        Console.WriteLine("Функции: черно-белое преобразование и перемещение");

        while (true)
        {
            ShowMenu();
            string choice = Console.ReadLine();

            if (choice == "1")
            {
                ConvertToBlackAndWhite();
            }
            else if (choice == "2")
            {
                MoveImage();
            }
            else if (choice == "3")
            {
                Console.WriteLine("Выход из программы...");
                break;
            }
            else
            {
                Console.WriteLine("Неверный выбор! Попробуйте снова.\n");
            }
        }
    }

    static void ShowMenu()
    {
        Console.WriteLine("\nВыберите действие:");
        Console.WriteLine("1 - Конвертировать в черно-белое");
        Console.WriteLine("2 - Переместить изображение");
        Console.WriteLine("3 - Выход");
        Console.Write("Ваш выбор: ");
    }

    static void ConvertToBlackAndWhite()
    {
        Console.WriteLine("\n--- Конвертация в черно-белое ---");

        // Получаем путь к исходному файлу
        Console.Write("Введите путь к исходному файлу: ");
        string sourcePath = Console.ReadLine();

        if (string.IsNullOrEmpty(sourcePath))
        {
            Console.WriteLine("Ошибка: Путь не может быть пустым!");
            return;
        }

        if (!File.Exists(sourcePath))
        {
            Console.WriteLine("Ошибка: Файл не существует!");
            return;
        }

        string extension = Path.GetExtension(sourcePath).ToLower();
        if (extension != ".png" && extension != ".jpg" && extension != ".jpeg" && extension != ".bmp")
        {
            Console.WriteLine("Ошибка: Поддерживаются только файлы PNG, JPG, JPEG и BMP!");
            return;
        }

        // Создаем путь для нового файла
        string directory = Path.GetDirectoryName(sourcePath);
        string fileNameWithoutExtension = Path.GetFileNameWithoutExtension(sourcePath);
        string newFilePath = Path.Combine(directory, fileNameWithoutExtension + "_bw" + extension);

        // Проверяем, не существует ли уже файл с таким именем
        if (File.Exists(newFilePath))
        {
            Console.WriteLine("Ошибка: Файл с таким именем уже существует!");
            return;
        }

        try
        {
            // Загружаем изображение
            using (Bitmap originalImage = new Bitmap(sourcePath))
            {
                // Создаем черно-белое изображение
                using (Bitmap bwImage = new Bitmap(originalImage.Width, originalImage.Height))
                {
                    for (int x = 0; x < originalImage.Width; x++)
                    {
                        for (int y = 0; y < originalImage.Height; y++)
                        {
                            Color originalColor = originalImage.GetPixel(x, y);

                            // Вычисляем яркость по формуле
                            int brightness = (int)(originalColor.R * 0.3 + originalColor.G * 0.59 + originalColor.B * 0.11);

                            // Создаем черно-белый цвет
                            Color bwColor = Color.FromArgb(brightness, brightness, brightness);

                            bwImage.SetPixel(x, y, bwColor);
                        }
                    }

                    // Сохраняем результат
                    if (extension == ".jpg" || extension == ".jpeg")
                    {
                        bwImage.Save(newFilePath, ImageFormat.Jpeg);
                    }
                    else if (extension == ".png")
                    {
                        bwImage.Save(newFilePath, ImageFormat.Png);
                    }
                    else if (extension == ".bmp")
                    {
                        bwImage.Save(newFilePath, ImageFormat.Bmp);
                    }
                }
            }

            Console.WriteLine($"Успех! Файл конвертирован в черно-белое: {newFilePath}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Ошибка при конвертации: {ex.Message}");
            return;
        }
    }

    static void MoveImage()
    {
        Console.WriteLine("\n--- Перемещение изображения ---");

        // Получаем путь к исходному файлу
        Console.Write("Введите путь к исходному файлу: ");
        string sourcePath = Console.ReadLine();

        if (string.IsNullOrEmpty(sourcePath))
        {
            Console.WriteLine("Ошибка: Путь не может быть пустым!");
            return;
        }

        if (!File.Exists(sourcePath))
        {
            Console.WriteLine("Ошибка: Файл не существует!");
            return;
        }

        string extension = Path.GetExtension(sourcePath).ToLower();
        if (extension != ".png" && extension != ".jpg" && extension != ".jpeg" && extension != ".bmp")
        {
            Console.WriteLine("Ошибка: Поддерживаются только файлы PNG, JPG, JPEG и BMP!");
            return;
        }

        // Получаем путь к целевой папке
        Console.Write("Введите путь к целевой папке: ");
        string targetFolder = Console.ReadLine();

        if (string.IsNullOrEmpty(targetFolder))
        {
            Console.WriteLine("Ошибка: Путь к папке не может быть пустым!");
            return;
        }

        // Проверяем существование папки, если нет - создаем
        if (!Directory.Exists(targetFolder))
        {
            Console.Write("Папка не существует. Создать? (y/n): ");
            string createChoice = Console.ReadLine();

            if (createChoice.ToLower() == "y" || createChoice.ToLower() == "yes" || createChoice.ToLower() == "д")
            {
                try
                {
                    Directory.CreateDirectory(targetFolder);
                    Console.WriteLine("Папка создана успешно.");
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Ошибка при создании папки: {ex.Message}");
                    return;
                }
            }
            else
            {
                Console.WriteLine("Перемещение отменено.");
                return;
            }
        }

        // Создаем полный путь для перемещения
        string fileName = Path.GetFileName(sourcePath);
        string destinationPath = Path.Combine(targetFolder, fileName);

        // Проверяем, не существует ли уже файл в целевой папке
        if (File.Exists(destinationPath))
        {
            Console.Write($"Файл {fileName} уже существует в целевой папке. Перезаписать? (y/n): ");
            string overwriteChoice = Console.ReadLine();

            if (!(overwriteChoice.ToLower() == "y" || overwriteChoice.ToLower() == "yes" || overwriteChoice.ToLower() == "д"))
            {
                Console.WriteLine("Перемещение отменено.");
                return;
            }
            else
            {
                // Удаляем существующий файл перед перемещением
                try
                {
                    File.Delete(destinationPath);
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Ошибка при удалении существующего файла: {ex.Message}");
                    return;
                }
            }
        }

        try
        {
            // Перемещаем файл (теперь без третьего параметра)
            File.Move(sourcePath, destinationPath);
            Console.WriteLine($"Успех! Файл перемещен: {destinationPath}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Ошибка при перемещении: {ex.Message}");
            return;
        }
    }
}
